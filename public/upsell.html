<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Special Offer - Santa's Certified Letters</title>
    
    <!-- HARDCODED TRACKDESK PIXEL - SALE -->
    <script>
        (function(t,d,k){(t[k]=t[k]||[]).push(d);t[d]=t[d]||t[k].f||function(){(t[d].q=t[d].q||[]).push(arguments)}})(window,"trackdesk","TrackdeskObject");
    </script>
    <script src="//cdn.trackdesk.com/tracking.js" async></script>
    <script>
        // Fire SALE pixel with order amount
        window.addEventListener('load', function() {
            console.log('üéØ HARDCODED SALE PIXEL FIRING NOW');
            
            // Get order amount from localStorage
            const orderAmount = parseFloat(localStorage.getItem('orderAmount') || '0');
            const orderToken = localStorage.getItem('orderToken') || '';
            
            console.log('üí∞ Order Amount:', orderAmount);
            console.log('üîñ Order Token:', orderToken);
            
            if (window.trackdesk && orderAmount > 0) {
                window.trackdesk("directwebinteractive", "conversion", {
                    "conversionType": "sale",
                    "orderId": orderToken,
                    "amount": orderAmount
                });
                console.log('‚úÖ SALE PIXEL FIRED - HARDCODED IN HTML');
                console.log('üìä Pixel Data:', { conversionType: 'sale', orderId: orderToken, amount: orderAmount });
            } else {
                console.error('‚ùå Trackdesk not available or order amount missing');
            }
        });
    </script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="min-h-screen bg-gradient-to-br from-red-700 via-green-700 to-red-800 flex items-center justify-center p-4">
        <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Timer Banner -->
            <div class="bg-red-600 text-white py-4 px-6 flex items-center justify-center gap-2">
                <svg class="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-lg font-bold">Limited Time Offer: <span id="timer">2:00</span></span>
            </div>

            <!-- Main Content -->
            <div class="grid lg:grid-cols-2 gap-8 p-6 lg:p-8">
                <!-- Left Column - Product Image -->
                <div class="flex flex-col items-center justify-start bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 lg:p-8 pt-4">
                    <img 
                        src="https://images.unsplash.com/photo-1673298062288-2df0ce037a1a?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxub3J0aCUyMHBvbGUlMjBzbm93JTIwd2ludGVyfGVufDF8fHx8MTc2Mzc2MjM3Nnww&ixlib=rb-4.1.0&q=80&w=1080" 
                        alt="Certified North Pole Snow"
                        class="w-full max-w-sm h-auto object-contain drop-shadow-2xl"
                    />
                    <div class="mt-4 text-center">
                        <h3 class="text-xl font-bold text-blue-900 mb-2">üéÑ Authentic North Pole Snow</h3>
                        <p class="text-gray-600">Certified & Collectible</p>
                    </div>
                    
                    <!-- Features List -->
                    <ul class="space-y-2 mt-4 w-full max-w-md">
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-gray-700">Authentic certified snow from the North Pole</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-gray-700">Beautiful collectible jar with certificate</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-gray-700">Perfect keepsake to treasure forever</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-gray-700">Ships FREE with your Santa letter order</span>
                        </li>
                    </ul>
                </div>

                <!-- Right Column - Offer Details -->
                <div class="flex flex-col justify-start">
                    <div class="mb-4">
                        <h1 class="text-3xl lg:text-4xl font-bold text-red-700 mb-3">
                            üéÅ Wait! Add Certified North Pole Snow!
                        </h1>
                        <p class="text-gray-700 text-lg leading-relaxed">
                            Complete your magical experience with authentic snow from the North Pole! 
                            This special jar of certified snow makes the perfect keepsake.
                        </p>
                    </div>

                    <!-- Price Badge -->
                    <div class="bg-green-50 border-2 border-green-600 rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-gray-700 font-medium">Special One-Time Offer</span>
                            <span class="text-3xl font-bold text-green-700">$9.99</span>
                        </div>
                        <p class="text-sm text-gray-600">per jar</p>
                    </div>

                    <!-- Quantity Selector -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-3 text-center">
                            Select Quantity:
                        </label>
                        
                        <!-- Quick Select Buttons -->
                        <div class="flex flex-wrap gap-2 mb-4 justify-center">
                            <button onclick="setQuantity(1)" id="qty-btn-1" class="px-6 py-3 rounded-lg font-semibold transition-all bg-green-600 text-white shadow-lg scale-105">
                                1
                            </button>
                            <button onclick="setQuantity(2)" id="qty-btn-2" class="px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">
                                2
                            </button>
                            <button onclick="setQuantity(3)" id="qty-btn-3" class="px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">
                                3
                            </button>
                            <button onclick="setQuantity(4)" id="qty-btn-4" class="px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">
                                4
                            </button>
                            <button onclick="setQuantity(5)" id="qty-btn-5" class="px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">
                                5
                            </button>
                        </div>

                        <!-- Plus/Minus Controls -->
                        <div class="flex items-center gap-4 justify-center">
                            <button onclick="decreaseQuantity()" id="minus-btn" class="px-8 py-3 rounded-lg font-bold text-xl border-2 border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                ‚àí
                            </button>
                            <div class="flex-1 text-center max-w-[100px]">
                                <div class="text-3xl font-bold text-gray-900" id="quantity-display">1</div>
                                <div class="text-sm text-gray-600" id="quantity-label">jar</div>
                            </div>
                            <button onclick="increaseQuantity()" id="plus-btn" class="px-8 py-3 rounded-lg font-bold text-xl border-2 border-gray-300 bg-white hover:bg-gray-50">
                                +
                            </button>
                        </div>

                        <!-- Total Price -->
                        <div class="mt-4 text-center py-3 bg-gray-50 rounded-lg">
                            <span class="text-gray-700">Total: </span>
                            <span class="text-2xl font-bold text-green-700" id="total-price">$9.99</span>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="error-message" class="hidden mb-3 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700"></div>

                    <!-- Action Buttons -->
                    <div class="space-y-3">
                        <button 
                            onclick="handleAccept()" 
                            id="accept-btn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-6 text-xl font-bold shadow-lg rounded-lg transition"
                        >
                            ‚úì Yes! Add <span id="btn-quantity">1</span> <span id="btn-jar-label">Jar</span> for $<span id="btn-price">9.99</span>
                        </button>

                        <button 
                            onclick="handleDecline()" 
                            id="decline-btn"
                            class="w-full text-gray-600 hover:text-gray-800 py-3 rounded-lg transition"
                        >
                            No thanks, I don't want this special offer
                        </button>
                    </div>

                    <p class="text-center text-sm text-gray-500 mt-3">
                        üîí Secure checkout ‚Ä¢ üí≥ Same payment method
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentQuantity = 1;
        let processing = false;
        let timeRemaining = 120; // 2 minutes

        // Timer countdown
        const timerInterval = setInterval(() => {
            timeRemaining--;
            const mins = Math.floor(timeRemaining / 60);
            const secs = timeRemaining % 60;
            document.getElementById('timer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                // Auto-redirect to success page or show downsell
                window.location.href = '/';
            }
        }, 1000);

        function setQuantity(qty) {
            currentQuantity = qty;
            updateUI();
        }

        function increaseQuantity() {
            currentQuantity++;
            updateUI();
        }

        function decreaseQuantity() {
            if (currentQuantity > 1) {
                currentQuantity--;
                updateUI();
            }
        }

        function updateUI() {
            // Update quantity display
            document.getElementById('quantity-display').textContent = currentQuantity;
            document.getElementById('quantity-label').textContent = currentQuantity === 1 ? 'jar' : 'jars';
            
            // Update total price
            const total = (9.99 * currentQuantity).toFixed(2);
            document.getElementById('total-price').textContent = `$${total}`;
            
            // Update button text
            document.getElementById('btn-quantity').textContent = currentQuantity;
            document.getElementById('btn-jar-label').textContent = currentQuantity === 1 ? 'Jar' : 'Jars';
            document.getElementById('btn-price').textContent = total;
            
            // Update quick select buttons
            for (let i = 1; i <= 5; i++) {
                const btn = document.getElementById(`qty-btn-${i}`);
                if (i === currentQuantity) {
                    btn.className = 'px-6 py-3 rounded-lg font-semibold transition-all bg-green-600 text-white shadow-lg scale-105';
                } else {
                    btn.className = 'px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200';
                }
            }
            
            // Update minus button state
            const minusBtn = document.getElementById('minus-btn');
            if (currentQuantity <= 1) {
                minusBtn.disabled = true;
                minusBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                minusBtn.disabled = false;
                minusBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function handleAccept() {
            if (processing) return;
            
            processing = true;
            const acceptBtn = document.getElementById('accept-btn');
            const errorDiv = document.getElementById('error-message');
            
            acceptBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline-block animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Adding to Order...
            `;
            acceptBtn.disabled = true;
            errorDiv.classList.add('hidden');

            try {
                const orderToken = localStorage.getItem('orderToken');
                
                const response = await fetch('https://zdufkwflqbfppldctjdh.supabase.co/functions/v1/make-server-cf244566/upsell/accept-snow', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkdWZrd2ZscWJmcHBsZGN0amRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2ODQ0MzYsImV4cCI6MjA1MTI2MDQzNn0.F2JQvl7lJ6NLe8ym7AMQqLdOYeFxMhBGOZmqg4cPvuc'
                    },
                    body: JSON.stringify({
                        orderToken: orderToken,
                        quantity: currentQuantity
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    acceptBtn.innerHTML = '‚úÖ Added Successfully!';
                    setTimeout(() => {
                        // Check if subscription was accepted during checkout
                        const subscriptionAccepted = localStorage.getItem('subscriptionAccepted') === 'true';
                        if (subscriptionAccepted) {
                            // Go straight to success page
                            window.location.href = '/?token=' + orderToken;
                        } else {
                            // Show subscription upsell (redirect to React app for this)
                            window.location.href = '/?token=' + orderToken + '&fromCheckout=true';
                        }
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Failed to add snow to order');
                }

            } catch (error) {
                console.error('Upsell error:', error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                acceptBtn.innerHTML = `‚úì Yes! Add ${currentQuantity} ${currentQuantity === 1 ? 'Jar' : 'Jars'} for $${(9.99 * currentQuantity).toFixed(2)}`;
                acceptBtn.disabled = false;
                processing = false;
            }
        }

        function handleDecline() {
            if (processing) return;
            
            const orderToken = localStorage.getItem('orderToken');
            const subscriptionAccepted = localStorage.getItem('subscriptionAccepted') === 'true';
            
            if (subscriptionAccepted) {
                // Go straight to success page
                window.location.href = '/?token=' + orderToken;
            } else {
                // Show subscription upsell
                window.location.href = '/?token=' + orderToken + '&fromCheckout=true';
            }
        }

        // Initialize UI
        updateUI();
    </script>
</body>
</html>
