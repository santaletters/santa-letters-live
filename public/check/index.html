<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letter Details - Letters From Santa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google Places API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBYhg6PoT-6qeVDsYnjUuJ655ilR5GxMtY&libraries=places"></script>
    
    <!-- Trackdesk Click Pixel -->
    <script>
    (function() {
        var td = document.createElement('script'); td.type = 'text/javascript'; td.async = true;
        td.src = 'https://i.trackdesk.com/tracking.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(td, s);
    })();
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .pacifico { 
            font-family: 'Pacifico', cursive; 
        }
        .envelope-border {
            border: 3px dashed #dc2626;
            background: linear-gradient(to bottom, #fef9f0, #fdf5e6);
            border-radius: 12px;
            position: relative;
        }
        .star {
            position: absolute;
            color: rgba(255, 255, 255, 0.3);
            font-size: 2rem;
            animation: twinkle 3s infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-white min-h-screen">
    
    <!-- Promo Banner -->
    <div class="bg-red-600 text-white text-center py-2">
        <p class="font-semibold">üéÑ Get 30% OFF + FREE Shipping + 2 Bonus Gifts! üéÑ</p>
        <p class="text-sm">Family Owned and Operated. All orders shipped from the USA!</p>
    </div>

    <!-- Header with Santa -->
    <div class="relative bg-gradient-to-b from-blue-900 via-blue-800 to-blue-700 text-white overflow-hidden py-8">
        <!-- Decorative stars and snowflakes -->
        <div class="star" style="top: 20px; left: 10%;">‚ùÑ</div>
        <div class="star" style="top: 50px; left: 80%;">‚òÖ</div>
        <div class="star" style="top: 80px; left: 20%;">‚òÖ</div>
        <div class="star" style="top: 40px; right: 15%;">‚ùÑ</div>
        <div class="star" style="top: 90px; left: 70%;">‚ùÑ</div>
        
        <div class="container mx-auto px-4 relative">
            <div class="grid md:grid-cols-3 items-center">
                <!-- Left: Back to Shop + Logo -->
                <div class="hidden md:flex items-center gap-4">
                    <a href="/" class="flex items-center gap-2 bg-blue-800 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors">
                        <span>‚Üê</span>
                        <span>Back to Shop</span>
                    </a>
                    <img src="https://images.unsplash.com/photo-1762417582191-e69cd1cb0609?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxzYW50YSUyMGxvZ28lMjBjaHJpc3RtYXN8ZW58MXx8fHwxNzY0MDA5NDcwfDA&ixlib=rb-4.1.0&q=80&w=1080" alt="Santa Logo" class="h-16 w-auto object-contain">
                </div>
                
                <!-- Mobile Back Button -->
                <div class="md:hidden mb-4">
                    <a href="/" class="inline-flex items-center gap-2 bg-blue-800 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors text-sm">
                        <span>‚Üê</span>
                        <span>Back to Shop</span>
                    </a>
                </div>
                
                <!-- Center: Red Ribbon Banner -->
                <div class="text-center">
                    <div class="relative inline-block bg-red-600 px-8 py-4 rounded-lg shadow-lg transform -rotate-2">
                        <div class="pacifico text-2xl md:text-3xl">Send your child a special</div>
                        <div class="pacifico text-3xl md:text-4xl">Letter From Santa</div>
                        <!-- Ribbon tails -->
                        <div class="absolute -left-4 top-1/2 w-4 h-8 bg-red-700 transform -translate-y-1/2 -skew-y-6"></div>
                        <div class="absolute -right-4 top-1/2 w-4 h-8 bg-red-700 transform -translate-y-1/2 skew-y-6"></div>
                    </div>
                </div>
                
                <!-- Right: Santa Image -->
                <div class="hidden md:block text-right">
                    <img src="https://images.unsplash.com/photo-1670540805686-a73a025c0dd1?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxzYW50YSUyMGNsYXVzJTIwZ2lmdHMlMjBwcmVzZW50c3xlbnwxfHx8fDE3NjQwMDk0NzB8MA&ixlib=rb-4.1.0&q=80&w=1080" alt="Santa with gifts" class="h-48 w-auto object-contain ml-auto">
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="bg-gray-50 py-6">
        <div class="container mx-auto px-4 max-w-4xl">
            <div class="flex items-center justify-center gap-4 md:gap-8">
                <!-- Step 1: Active -->
                <div class="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-full shadow-md">
                    <div class="flex items-center justify-center w-8 h-8 bg-white text-green-500 rounded-full font-bold">1</div>
                    <span class="hidden md:inline font-semibold">Customize Letters</span>
                </div>
                
                <div class="w-8 md:w-16 h-1 bg-gray-300"></div>
                
                <!-- Step 2: Inactive -->
                <div class="flex items-center gap-2 bg-gray-300 text-gray-600 px-4 py-2 rounded-full">
                    <div class="flex items-center justify-center w-8 h-8 bg-white text-gray-600 rounded-full font-bold">2</div>
                    <span class="hidden md:inline font-semibold">Complete Order</span>
                </div>
                
                <div class="w-8 md:w-16 h-1 bg-gray-300"></div>
                
                <!-- Step 3: Inactive -->
                <div class="flex items-center gap-2 bg-gray-300 text-gray-600 px-4 py-2 rounded-full">
                    <div class="flex items-center justify-center w-8 h-8 bg-white text-gray-600 rounded-full font-bold">3</div>
                    <span class="hidden md:inline font-semibold">Letter Sent</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="bg-gray-50 py-12">
        <div class="container mx-auto px-4 max-w-4xl">
            <!-- Letter Forms Container -->
            <div id="letters-container" class="space-y-8"></div>

            <!-- Buttons Container - Positioned right after forms -->
            <div class="mt-8 flex flex-col md:flex-row gap-4 justify-center items-center">
                <button id="add-letter-btn" class="inline-flex items-center gap-2 bg-white hover:bg-gray-50 text-green-600 border-2 border-green-600 px-6 py-3 rounded-lg font-semibold transition-all shadow-md hover:shadow-lg">
                    <span class="text-xl">+</span>
                    Add Another Letter
                </button>
                
                <button id="continue-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-bold transition-all shadow-lg hover:shadow-xl">
                    Verify & Complete My Order ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Testimonials Section -->
    <div class="bg-white py-16">
        <div class="container mx-auto px-4 max-w-6xl">
            <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-12">What Our Customers Are Saying</h2>
            
            <div class="grid md:grid-cols-3 gap-8 mb-12">
                <!-- Testimonial 1 -->
                <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
                    <p class="font-semibold text-gray-800 mb-4">You guys are amazing!</p>
                    <p class="text-gray-600 text-sm mb-4">My 8-year-old daughter and my 4-year-old son look forward to their letters every year. Thank you for bringing so much joy and excitement to their faces!</p>
                    <div class="flex gap-1 mb-3">
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="text-yellow-400">‚òÖ</span>
                    </div>
                    <p class="text-sm text-gray-500">Emily Patterson</p>
                </div>

                <!-- Testimonial 2 -->
                <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
                    <p class="font-semibold text-gray-800 mb-4">Love these memories!</p>
                    <p class="text-gray-600 text-sm mb-4">My grandkids light up with joy every time they get their letters from Santa. The look on their faces is absolutely priceless, such a wonderful tradition and memory we're creating for them each year!</p>
                    <div class="flex gap-1 mb-3">
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="text-yellow-400">‚òÖ</span>
                    </div>
                    <p class="text-sm text-gray-500">Linda Matthews</p>
                </div>

                <!-- Testimonial 3 -->
                <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100">
                    <p class="font-semibold text-gray-800 mb-4">Thank you so much!</p>
                    <p class="text-gray-600 text-sm mb-4">This is my fourth year ordering, and my boys still get just as excited as the very first time! They absolutely love it, thank you so much for keeping the magic alive!</p>
                    <div class="flex gap-1 mb-3">
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="text-yellow-400">‚òÖ</span>
                    </div>
                    <p class="text-sm text-gray-500">Karen Phillips</p>
                </div>
            </div>

            <!-- Money Back Guarantee -->
            <div class="text-center">
                <p class="text-xl font-semibold text-gray-700">100% Money Back Guarantee</p>
            </div>
        </div>
    </div>

    <!-- Footer Info -->
    <div class="bg-gray-100 py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-700 mb-2">Customer Support 7 Days A Week: 9am to 7pm EST</p>
            <p class="text-blue-600 mb-2">
                <a href="mailto:hello@santascertifiedletter.com" class="hover:underline">hello@santascertifiedletter.com</a> | 
                <a href="tel:(800) 540-7716" class="hover:underline">(800) 540-7716</a>
            </p>
            <p class="text-sm text-gray-600">
                <a href="/contact" class="hover:underline">Contact Us</a> | 
                <a href="/privacy" class="hover:underline">Privacy Policy</a> | 
                <a href="/terms" class="hover:underline">Terms & Conditions</a>
            </p>
            <p class="text-sm text-gray-500 mt-4">Santa's Certified Letter ¬© 2025</p>
        </div>
    </div>

    <script>
        // Load saved data from localStorage
        let packages = [];
        
        // Try to load existing packages
        const savedPackages = localStorage.getItem('santaLetterPackages');
        if (savedPackages) {
            try {
                packages = JSON.parse(savedPackages);
                // Remove packageType for funnel orders
                packages = packages.map(pkg => ({
                    childFirstName: pkg.childFirstName || '',
                    childLastName: pkg.childLastName || '',
                    friendName: pkg.friendName || '',
                    streetAddress: pkg.streetAddress || '',
                    unitApt: pkg.unitApt || '',
                    city: pkg.city || '',
                    state: pkg.state || '',
                    zipCode: pkg.zipCode || ''
                }));
            } catch (e) {
                console.error('Error loading saved packages:', e);
            }
        }
        
        // If no saved packages, create one empty package
        if (packages.length === 0) {
            packages.push({
                childFirstName: '',
                childLastName: '',
                friendName: '',
                streetAddress: '',
                unitApt: '',
                city: '',
                state: '',
                zipCode: ''
            });
        }

        // US States for dropdown
        const states = [
            'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 'Delaware', 
            'Florida', 'Georgia', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 
            'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi', 
            'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey', 'New Mexico', 
            'New York', 'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 
            'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont', 
            'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming'
        ];

        // Store current scroll position before re-render
        let preserveScrollPosition = false;
        let scrollPosition = 0;

        // Render letter forms
        function renderLetters() {
            const container = document.getElementById('letters-container');
            
            // Save scroll position if needed
            if (preserveScrollPosition) {
                scrollPosition = window.scrollY;
            }
            
            container.innerHTML = '';
            
            packages.forEach((pkg, index) => {
                const letterDiv = document.createElement('div');
                letterDiv.className = 'envelope-border rounded-xl shadow-lg p-6 md:p-8';
                letterDiv.id = `package-${index}`; // Add ID for scrolling
                letterDiv.innerHTML = `
                    <div class="mb-6 flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-blue-900">Santa Package #${index + 1}</h2>
                        ${packages.length > 1 ? `
                            <button class="delete-letter-btn flex items-center gap-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-all" data-index="${index}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Remove
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Child's First Name *</label>
                                <input type="text" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none bg-blue-50" value="${pkg.childFirstName || ''}" data-index="${index}" data-field="childFirstName" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Child's Last Name *</label>
                                <input type="text" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none bg-blue-50" value="${pkg.childLastName || ''}" data-index="${index}" data-field="childLastName" required>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Friends Name (Optional)</label>
                            <input type="text" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none bg-blue-50" value="${pkg.friendName || ''}" data-index="${index}" data-field="friendName" placeholder="Santa will mention them in the letter">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Street Address *</label>
                            <p class="text-xs text-gray-500 mb-1">Where The Letter Should Be Delivered:</p>
                            <input type="text" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none bg-yellow-50" value="${pkg.streetAddress || ''}" data-index="${index}" data-field="streetAddress" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Unit/APT#</label>
                            <input type="text" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none bg-yellow-50" value="${pkg.unitApt || ''}" data-index="${index}" data-field="unitApt">
                        </div>
                        
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">City *</label>
                                <input type="text" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none bg-yellow-50" value="${pkg.city || ''}" data-index="${index}" data-field="city" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">State *</label>
                                <select class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none bg-yellow-50" data-index="${index}" data-field="state" required>
                                    <option value="">Select State</option>
                                    ${states.map(state => `<option value="${state}" ${pkg.state === state ? 'selected' : ''}>${state}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Zip Code *</label>
                                <input type="text" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none bg-yellow-50" value="${pkg.zipCode || ''}" data-index="${index}" data-field="zipCode" maxlength="5" required>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(letterDiv);
            });

            // Restore scroll position if needed
            if (preserveScrollPosition) {
                setTimeout(() => {
                    window.scrollTo(0, scrollPosition);
                    preserveScrollPosition = false;
                }, 0);
            }

            // Attach event listeners for inputs and selects
            document.querySelectorAll('input[data-index], select[data-index]').forEach(input => {
                input.addEventListener('input', function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    packages[index][field] = this.value;
                    saveToLocalStorage();
                });
                
                input.addEventListener('change', function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    packages[index][field] = this.value;
                    saveToLocalStorage();
                });
            });

            // Attach event listeners for delete buttons
            document.querySelectorAll('.delete-letter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    packages.splice(index, 1);
                    saveToLocalStorage();
                    // Preserve scroll position when deleting
                    preserveScrollPosition = true;
                    renderLetters();
                });
            });

            // Initialize Google Places Autocomplete for each street address field
            document.querySelectorAll('input[data-field="streetAddress"]').forEach(input => {
                const index = parseInt(input.dataset.index);
                
                // Create autocomplete instance
                const autocomplete = new google.maps.places.Autocomplete(input, {
                    types: ['address'],
                    componentRestrictions: { country: 'us' }
                });

                // When user selects an address from dropdown
                autocomplete.addListener('place_changed', function() {
                    const place = autocomplete.getPlace();
                    
                    if (!place.geometry) {
                        console.log('No details available for input:', place.name);
                        return;
                    }

                    // Parse address components
                    let streetNumber = '';
                    let route = '';
                    let city = '';
                    let state = '';
                    let zipCode = '';

                    place.address_components.forEach(component => {
                        const types = component.types;
                        
                        if (types.includes('street_number')) {
                            streetNumber = component.long_name;
                        }
                        if (types.includes('route')) {
                            route = component.long_name;
                        }
                        if (types.includes('locality')) {
                            city = component.long_name;
                        }
                        if (types.includes('administrative_area_level_1')) {
                            state = component.long_name; // Full state name
                        }
                        if (types.includes('postal_code')) {
                            zipCode = component.long_name;
                        }
                    });

                    // Update package data
                    const fullAddress = `${streetNumber} ${route}`.trim();
                    packages[index].streetAddress = fullAddress;
                    packages[index].city = city;
                    packages[index].state = state;
                    packages[index].zipCode = zipCode;

                    // Save and re-render to show the updated values
                    saveToLocalStorage();
                    preserveScrollPosition = true;
                    renderLetters();

                    console.log('‚úÖ Address autofilled:', {
                        streetAddress: fullAddress,
                        city,
                        state,
                        zipCode
                    });
                });
            });
        }

        // Save to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('santaLetterPackages', JSON.stringify(packages));
            console.log('‚úÖ Saved to localStorage:', packages);
        }

        // Add another letter
        document.getElementById('add-letter-btn').addEventListener('click', function() {
            packages.push({
                childFirstName: '',
                childLastName: '',
                friendName: '',
                streetAddress: '',
                unitApt: '',
                city: '',
                state: '',
                zipCode: ''
            });
            saveToLocalStorage();
            renderLetters();
            // Scroll to new letter
            setTimeout(() => {
                const newPackage = document.getElementById(`package-${packages.length - 1}`);
                if (newPackage) {
                    newPackage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        });

        // Continue to checkout
        document.getElementById('continue-btn').addEventListener('click', function() {
            // Validate all required fields
            let isValid = true;
            let firstInvalidIndex = -1;
            
            packages.forEach((pkg, index) => {
                if (!pkg.childFirstName || !pkg.childLastName || !pkg.streetAddress || !pkg.city || !pkg.state || !pkg.zipCode) {
                    isValid = false;
                    if (firstInvalidIndex === -1) {
                        firstInvalidIndex = index;
                    }
                }
            });

            if (!isValid) {
                alert(`Please fill in all required fields for Santa Package #${firstInvalidIndex + 1}`);
                return;
            }

            if (packages.length === 0) {
                alert('Please add at least one letter');
                return;
            }

            saveToLocalStorage();
            // Redirect to checkout
            window.location.href = '/checkout/';
        });

        // Initial render
        renderLetters();
    </script>

</body>
</html>
