<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Order - Santa's Certified Letters</title>
    
    <!-- HARDCODED TRACKDESK PIXEL - LEAD -->
    <script>
        (function(t,d,k){(t[k]=t[k]||[]).push(d);t[d]=t[d]||t[k].f||function(){(t[d].q=t[d].q||[]).push(arguments)}})(window,"trackdesk","TrackdeskObject");
    </script>
    <script src="//cdn.trackdesk.com/tracking.js" async></script>
    <script>
        // Fire LEAD pixel immediately
        window.addEventListener('load', function() {
            console.log('üéØ HARDCODED LEAD PIXEL FIRING NOW');
            if (window.trackdesk) {
                window.trackdesk("directwebinteractive", "conversion", {
                    "conversionType": "lead"
                });
                console.log('‚úÖ LEAD PIXEL FIRED - HARDCODED IN HTML');
            } else {
                console.error('‚ùå Trackdesk not available');
            }
        });
    </script>
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
        }
        .StripeElement {
            padding: 16px 14px;
            border: 2px solid #d1d5db;
            border-radius: 0.375rem;
            background: white;
            height: 48px;
        }
        .StripeElement--focus {
            border-color: #3b82f6;
        }
        .StripeElement--invalid {
            border-color: #dc2626;
        }
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .success-message {
            color: #16a34a;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- Promo Banner -->
    <div class="bg-red-600 text-white text-center pt-3 pb-2 md:pt-2 md:pb-2">
        <p>üéÑ Get 30% OFF + FREE Shipping + 2 Bonus Gifts! üéÑ</p>
        <p class="text-sm">Family Owned and Operated. All orders shipped from the USA!</p>
    </div>

    <!-- Header with Santa -->
    <div class="relative bg-gradient-to-b from-blue-900 to-blue-800 text-white overflow-hidden pt-4 pb-10">
        <!-- Snowflakes decoration -->
        <div class="absolute inset-0 opacity-20 pointer-events-none">
            <div class="absolute top-10 left-10 text-white text-2xl">‚ùÑ</div>
            <div class="absolute top-20 right-20 text-white text-xl">‚ùÑ</div>
            <div class="absolute top-32 left-1/4 text-white text-lg">‚ùÑ</div>
            <div class="absolute top-16 right-1/3 text-white text-2xl">‚òÖ</div>
            <div class="absolute top-24 left-1/3 text-white text-xl">‚òÖ</div>
            <div class="absolute top-40 right-1/4 text-white text-lg">‚òÖ</div>
        </div>
        
        <div class="container mx-auto px-4 py-6 relative h-32">
            <div class="flex items-start justify-between">
                <!-- Logo - Desktop Only -->
                <div class="hidden md:flex items-center gap-2">
                    <img 
                        src="https://images.unsplash.com/photo-1762417582191-e69cd1cb0609?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxzYW50YSUyMGNsYXVzJTIwbG9nb3xlbnwxfHx8fDE3NjM3NjIzNzZ8MA&ixlib=rb-4.1.0&q=80&w=1080"
                        alt="Santa's Official Letter"
                        class="h-16 w-auto"
                    />
                </div>
                
                <!-- Centered Red Ribbon Banner -->
                <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm px-4">
                    <img 
                        src="https://images.unsplash.com/photo-1544724586-e364c71e2b55?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxyZWQlMjByaWJib24lMjBiYW5uZXJ8ZW58MXx8fHwxNzYzNzYyMzc2fDA&ixlib=rb-4.1.0&q=80&w=1080"
                        alt="Send your child a special Letter From Santa"
                        class="w-full h-auto"
                    />
                </div>
                
                <!-- Santa Image - Top Right - Desktop Only -->
                <div class="hidden md:block absolute top-0 right-0 w-72 h-auto pointer-events-none">
                    <img 
                        src="https://images.unsplash.com/photo-1703753936800-593a07d2285b?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxzYW50YSUyMGNsYXVzJTIwZ2lmdHMlMjBwcmVzZW50c3xlbnwxfHx8fDE3NjM3NjIzNzV8MA&ixlib=rb-4.1.0&q=80&w=1080"
                        alt="Santa with gifts"
                        class="w-full h-auto"
                        style="filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3))"
                    />
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="bg-white border-b">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-center gap-4 max-w-2xl mx-auto">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center">
                        ‚úì
                    </div>
                    <span class="text-sm text-gray-600">Customize Your Letters</span>
                </div>
                <div class="h-px w-12 bg-gray-300"></div>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center">
                        ‚úì
                    </div>
                    <span class="text-sm text-gray-600">Complete Order</span>
                </div>
                <div class="h-px w-12 bg-gray-300"></div>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-gray-300 text-white flex items-center justify-center">
                        3
                    </div>
                    <span class="text-sm text-gray-400">Letter Sent to Your House</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Form -->
    <div class="container mx-auto px-4 py-12">
        <div class="flex flex-col lg:grid lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
            <!-- Order Summary - Right Column on Desktop -->
            <div class="lg:col-span-1 lg:order-2 order-1">
                <div class="lg:sticky lg:top-4">
                    <!-- Order Summary -->
                    <div class="bg-blue-50 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-6 text-center border-b pb-4">Order Summary</h3>
                        
                        <div id="order-items" class="mb-6 space-y-4"></div>

                        <!-- Add Another Letter Button -->
                        <button 
                            onclick="addAnotherLetter()" 
                            class="text-blue-600 hover:underline text-sm mb-4 block"
                        >
                            + Add Another Letter
                        </button>

                        <div class="border-t pt-4 mb-6" id="order-totals">
                            <div class="flex justify-between mb-2">
                                <span>Sub Total (<span id="package-count">0</span> <span id="package-label">packages</span>)</span>
                                <span id="subtotal">$0.00</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span>Shipping</span>
                                <span class="text-green-600">Free</span>
                            </div>
                            <div id="subscription-line" class="hidden mb-2 text-green-600">
                                <div class="flex justify-between">
                                    <div>
                                        <div>Monthly Letters + 2 FREE Gifts</div>
                                        <div class="text-xs text-gray-600">Starts January 2025 - $12/month</div>
                                    </div>
                                    <span>$0.00</span>
                                </div>
                            </div>
                            <div class="flex justify-between border-t pt-2 mt-2">
                                <span class="font-bold">Total Today</span>
                                <span class="font-bold" id="grand-total">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Money Back Guarantee -->
                    <div class="hidden lg:block bg-white rounded-lg p-6 text-center shadow-sm mt-6 border border-gray-200">
                        <img 
                            src="https://images.unsplash.com/photo-1728057213505-775a6ebebf29?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxtb25leSUyMGJhY2slMjBndWFyYW50ZWUlMjBiYWRnZXxlbnwxfHx8fDE3NjM3NjIzNzd8MA&ixlib=rb-4.1.0&q=80&w=1080"
                            alt="100% Money Back Guaranteed"
                            class="w-32 h-32 mx-auto mb-4"
                        />
                        <h4 class="font-bold mb-3">100% Money Back Guarantee</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            If your child doesn't absolutely love their letter, we'll issue you a full 100% refund
                        </p>
                        <p class="text-sm text-gray-700">
                            No Questions - No Hassle - No Waiting
                        </p>
                    </div>
                </div>
            </div>

            <!-- Form - Left Column on Desktop -->
            <div class="lg:col-span-2 lg:order-1 order-2">
                <div>
                    <!-- Security Badges -->
                    <div class="bg-blue-900 text-white rounded-lg p-6 mb-6 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            <div>
                                <p class="text-sm font-bold">Safe & Secure</p>
                                <p class="text-xs text-blue-200">Order Form</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            <div class="text-right">
                                <p class="text-sm font-bold">256-Bit Secure</p>
                                <p class="text-xs text-blue-200">Encryption</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-center mb-6">
                        <img 
                            src="https://images.unsplash.com/photo-1580062329539-c76d0cce5c4c?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxzZWN1cmUlMjBwYXltZW50JTIwYmFkZ2VzfGVufDF8fHx8MTc2Mzc2MjM3N3ww&ixlib=rb-4.1.0&q=80&w=1080"
                            alt="Guaranteed Safe Checkout - Visa, Mastercard, American Express, Discover"
                            class="h-16 w-auto max-w-full"
                        />
                    </div>

                    <form id="payment-form">
                        <!-- Contact Information -->
                        <div class="bg-blue-900 text-white px-6 py-3 rounded-t-lg flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <h3 class="font-bold">Contact Information</h3>
                        </div>
                        <div class="border border-blue-900 rounded-b-lg p-6 mb-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <p class="text-sm text-blue-900">
                                    <strong>Contact Information:</strong> Provide email and/or phone (you can provide both!)
                                </p>
                            </div>

                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-bold">Email</label>
                                    <input type="email" id="email" required class="w-full border-2 border-gray-300 h-12 px-4 rounded" placeholder="your@email.com">
                                    <div id="email-error" class="error-message hidden"></div>
                                    <div id="email-success" class="success-message hidden">‚úì Valid email</div>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2 font-bold">Phone</label>
                                    <input type="tel" id="phone" class="w-full border-2 border-gray-300 h-12 px-4 rounded" placeholder="(555) 123-4567">
                                    <div id="phone-error" class="error-message hidden"></div>
                                    <div id="phone-success" class="success-message hidden">‚úì Valid phone number</div>
                                </div>
                            </div>
                        </div>

                        <!-- Billing Information -->
                        <div class="bg-blue-900 text-white px-6 py-3 rounded-t-lg flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            <h3 class="font-bold">Billing Information</h3>
                        </div>
                        <div class="border border-blue-900 rounded-b-lg p-6 mb-6">
                            <div class="grid md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-gray-700 mb-2">First Name</label>
                                    <input type="text" id="firstName" required class="w-full border-2 border-gray-300 h-12 px-4 rounded">
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Last Name</label>
                                    <input type="text" id="lastName" required class="w-full border-2 border-gray-300 h-12 px-4 rounded">
                                </div>
                            </div>

                            <div class="mb-6">
                                <label class="block text-gray-700 mb-2">Address</label>
                                <input type="text" id="address" required class="w-full border-2 border-gray-300 h-12 px-4 rounded">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2">City</label>
                                    <input type="text" id="city" required class="w-full border-2 border-gray-300 h-12 px-4 rounded">
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">State</label>
                                    <select id="state" required class="w-full border-2 border-gray-300 h-12 px-4 rounded bg-white">
                                        <option value="">Select State</option>
                                        <option value="AL">Alabama</option>
                                        <option value="AK">Alaska</option>
                                        <option value="AZ">Arizona</option>
                                        <option value="AR">Arkansas</option>
                                        <option value="CA">California</option>
                                        <option value="CO">Colorado</option>
                                        <option value="CT">Connecticut</option>
                                        <option value="DE">Delaware</option>
                                        <option value="FL">Florida</option>
                                        <option value="GA">Georgia</option>
                                        <option value="HI">Hawaii</option>
                                        <option value="ID">Idaho</option>
                                        <option value="IL">Illinois</option>
                                        <option value="IN">Indiana</option>
                                        <option value="IA">Iowa</option>
                                        <option value="KS">Kansas</option>
                                        <option value="KY">Kentucky</option>
                                        <option value="LA">Louisiana</option>
                                        <option value="ME">Maine</option>
                                        <option value="MD">Maryland</option>
                                        <option value="MA">Massachusetts</option>
                                        <option value="MI">Michigan</option>
                                        <option value="MN">Minnesota</option>
                                        <option value="MS">Mississippi</option>
                                        <option value="MO">Missouri</option>
                                        <option value="MT">Montana</option>
                                        <option value="NE">Nebraska</option>
                                        <option value="NV">Nevada</option>
                                        <option value="NH">New Hampshire</option>
                                        <option value="NJ">New Jersey</option>
                                        <option value="NM">New Mexico</option>
                                        <option value="NY">New York</option>
                                        <option value="NC">North Carolina</option>
                                        <option value="ND">North Dakota</option>
                                        <option value="OH">Ohio</option>
                                        <option value="OK">Oklahoma</option>
                                        <option value="OR">Oregon</option>
                                        <option value="PA">Pennsylvania</option>
                                        <option value="RI">Rhode Island</option>
                                        <option value="SC">South Carolina</option>
                                        <option value="SD">South Dakota</option>
                                        <option value="TN">Tennessee</option>
                                        <option value="TX">Texas</option>
                                        <option value="UT">Utah</option>
                                        <option value="VT">Vermont</option>
                                        <option value="VA">Virginia</option>
                                        <option value="WA">Washington</option>
                                        <option value="WV">West Virginia</option>
                                        <option value="WI">Wisconsin</option>
                                        <option value="WY">Wyoming</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">ZIP Code</label>
                                    <input type="text" id="zip" required class="w-full border-2 border-gray-300 h-12 px-4 rounded" placeholder="12345">
                                    <div id="zip-error" class="error-message hidden"></div>
                                    <div id="zip-success" class="success-message hidden">‚úì Valid ZIP code</div>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Date -->
                        <div class="bg-red-600 text-white px-6 py-3 rounded-t-lg">
                            <h3>üìÖ Choose Your Shipping Date <span class="text-sm">(Required)</span></h3>
                        </div>
                        <div class="border border-red-600 rounded-b-lg p-6 mb-6">
                            <div class="space-y-3">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="shippingDate" value="nov15" class="w-5 h-5">
                                    <span class="text-gray-700">üìÜ November 15th</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="shippingDate" value="dec1" class="w-5 h-5">
                                    <span class="text-gray-700">üìÜ December 1st</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="shippingDate" value="dec10" class="w-5 h-5">
                                    <span class="text-gray-700">üìÜ December 10th</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="shippingDate" value="dec15" checked class="w-5 h-5">
                                    <span class="text-gray-700">üìÜ December 15th (Recommended)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Monthly Subscription -->
                        <div class="bg-gradient-to-r from-green-600 to-green-500 text-white rounded-lg p-6 mb-6 shadow-lg">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0">
                                    <input type="checkbox" id="monthlySubscription" class="mt-1 h-6 w-6 border-2 border-white rounded">
                                </div>
                                <div class="flex-1">
                                    <label for="monthlySubscription" class="cursor-pointer block">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-xl">üéÅ</span>
                                            <h4 class="text-lg font-bold">YES! Add Santa's Magical Journey + Get 2 FREE GIFTS!</h4>
                                        </div>
                                        <p class="text-sm text-white/90 mb-2">
                                            Keep the magic alive all year! Get a personalized letter from Santa every month.
                                        </p>
                                        <div class="bg-white/20 rounded-lg p-3 mb-2">
                                            <p class="text-sm mb-1 font-semibold">‚ú® Your 2 FREE Bonus Gifts:</p>
                                            <ul class="text-sm space-y-1 ml-4">
                                                <li>üéÑ Santa's Workshop VIP Badge</li>
                                                <li>üéÖ Nice List Gold Pass</li>
                                            </ul>
                                            <p class="text-xs text-white/90 mt-2">
                                                Both authorized with a personalized Autographed Photo of Santa!
                                            </p>
                                        </div>
                                        <p class="text-xs text-white/80" id="subscription-price">
                                            Only $12/month starting in January. Cancel anytime with no hassle!
                                        </p>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Information -->
                        <div class="bg-blue-900 text-white px-6 py-3 rounded-t-lg flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            <h3 class="font-bold">Payment Information</h3>
                        </div>
                        <div class="border border-blue-900 rounded-b-lg p-6 mb-6">
                            <div class="mb-6 flex items-center gap-3">
                                <p class="text-sm text-gray-600 font-bold">We Accept:</p>
                                <img 
                                    src="https://images.unsplash.com/photo-1658842244540-883aff68fb78?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxjcmVkaXQlMjBjYXJkJTIwbG9nb3N8ZW58MXx8fHwxNzYzNzYyMzc4fDA&ixlib=rb-4.1.0&q=80&w=1080"
                                    alt="Visa, Mastercard, American Express, Discover"
                                    class="h-5 w-auto"
                                />
                            </div>
                            <div id="card-element" class="mb-4"></div>
                            <div id="card-errors" class="error-message"></div>
                        </div>

                        <button type="submit" id="submit-button" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 rounded-lg text-xl font-bold hover:from-green-700 hover:to-green-800 transition shadow-lg">
                            Complete Order Securely üéÖ
                        </button>
                        
                        <div id="payment-status" class="mt-4 text-center"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get cart data from localStorage
        let letterPackages = JSON.parse(localStorage.getItem('santaLetterPackages') || '[]');
        
        // Render order items
        function renderOrderItems() {
            let total = 0;
            const orderItems = document.getElementById('order-items');
            orderItems.innerHTML = '';
            
            letterPackages.forEach((pkg, idx) => {
                const price = pkg.packageType === 'basic' ? 19.99 : pkg.packageType === 'deluxe' ? 29.99 : 59.99;
                total += price;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'pb-4 border-b border-gray-200 last:border-b-0';
                itemDiv.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                            <p class="text-sm font-semibold">${pkg.packageName || 'Santa Package #' + (idx + 1)}</p>
                            <p class="text-sm text-gray-600">$${price.toFixed(2)}</p>
                        </div>
                        <div class="flex flex-col gap-1">
                            <button 
                                onclick="editPackage(${idx})" 
                                class="text-xs text-blue-600 hover:text-blue-700 hover:bg-blue-50 px-2 py-1 rounded flex items-center gap-1"
                            >
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit
                            </button>
                            <button 
                                onclick="deletePackage(${idx})" 
                                class="text-xs text-red-600 hover:text-red-700 hover:bg-red-50 px-2 py-1 rounded flex items-center gap-1"
                            >
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Delete
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">
                        Child's Name: ${pkg.childFirstName || 'Not provided'} ${pkg.childLastName || ''}
                    </p>
                    <p class="text-sm text-gray-600 mb-1">
                        Ship To: ${pkg.city || 'Not provided'}, ${pkg.state || 'XX'}
                    </p>
                    ${pkg.streetAddress ? `<p class="text-sm text-gray-600 mb-1">${pkg.streetAddress} ${pkg.unitApt || ''}</p>` : ''}
                `;
                orderItems.appendChild(itemDiv);
            });
            
            document.getElementById('package-count').textContent = letterPackages.length;
            document.getElementById('package-label').textContent = letterPackages.length === 1 ? 'package' : 'packages';
            document.getElementById('subtotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('grand-total').textContent = `$${total.toFixed(2)}`;

            // Update subscription price
            document.getElementById('subscription-price').textContent = 
                `Only $${12 * letterPackages.length}/month (${letterPackages.length} ${letterPackages.length === 1 ? 'child' : 'children'} √ó $12) starting in January. Cancel anytime with no hassle!`;
        }

        function editPackage(idx) {
            alert('To edit this package, please go back to the previous page.');
            // In a real implementation, you'd redirect back to the form with the package index
        }

        function deletePackage(idx) {
            if (confirm(`Are you sure you want to delete Santa Package #${idx + 1}?`)) {
                letterPackages.splice(idx, 1);
                localStorage.setItem('santaLetterPackages', JSON.stringify(letterPackages));
                if (letterPackages.length === 0) {
                    alert('You must have at least one package. Redirecting back...');
                    window.history.back();
                } else {
                    renderOrderItems();
                }
            }
        }

        function addAnotherLetter() {
            alert('To add another letter, please go back to the previous page.');
            // In a real implementation, you'd redirect back to the form
        }

        // Initialize order display
        renderOrderItems();

        // Initialize Stripe
        const stripe = Stripe('pk_live_51SIHQT2NsH2CKfRANHrn5PsrTTnvRY0t5QStLGW8W3ihy4dhFVhDX4ZIP3lrOYhA1HPtnflUgDAhDxEZ0TgNB1V000lsmZhQBB');
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        cardElement.mount('#card-element');

        // Handle card errors
        cardElement.on('change', (event) => {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });

        // Email validation
        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value;
            const errorDiv = document.getElementById('email-error');
            const successDiv = document.getElementById('email-success');
            
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                this.classList.add('border-red-500');
                this.classList.remove('border-green-500', 'border-gray-300');
                errorDiv.textContent = 'Please enter a valid email address';
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
            } else if (email) {
                this.classList.add('border-green-500');
                this.classList.remove('border-red-500', 'border-gray-300');
                errorDiv.classList.add('hidden');
                successDiv.classList.remove('hidden');
            } else {
                this.classList.remove('border-red-500', 'border-green-500');
                this.classList.add('border-gray-300');
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
            }
        });

        // Phone validation
        document.getElementById('phone').addEventListener('blur', function() {
            const phone = this.value.replace(/\D/g, '');
            const errorDiv = document.getElementById('phone-error');
            const successDiv = document.getElementById('phone-success');
            
            if (this.value && phone.length < 10) {
                this.classList.add('border-red-500');
                this.classList.remove('border-green-500', 'border-gray-300');
                errorDiv.textContent = 'Please enter at least 10 digits';
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
            } else if (this.value && phone.length >= 10) {
                this.classList.add('border-green-500');
                this.classList.remove('border-red-500', 'border-gray-300');
                errorDiv.classList.add('hidden');
                successDiv.classList.remove('hidden');
            } else {
                this.classList.remove('border-red-500', 'border-green-500');
                this.classList.add('border-gray-300');
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
            }
        });

        // ZIP validation
        document.getElementById('zip').addEventListener('blur', function() {
            const zip = this.value;
            const errorDiv = document.getElementById('zip-error');
            const successDiv = document.getElementById('zip-success');
            
            if (zip && !/^\d{5}(-\d{4})?$/.test(zip)) {
                this.classList.add('border-red-500');
                this.classList.remove('border-green-500', 'border-gray-300');
                errorDiv.textContent = 'Please enter a valid 5-digit US ZIP code';
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
            } else if (zip) {
                this.classList.add('border-green-500');
                this.classList.remove('border-red-500', 'border-gray-300');
                errorDiv.classList.add('hidden');
                successDiv.classList.remove('hidden');
            } else {
                this.classList.remove('border-red-500', 'border-green-500');
                this.classList.add('border-gray-300');
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
            }
        });

        // Update subscription line in order summary
        document.getElementById('monthlySubscription').addEventListener('change', function() {
            const subscriptionLine = document.getElementById('subscription-line');
            if (this.checked) {
                subscriptionLine.classList.remove('hidden');
            } else {
                subscriptionLine.classList.add('hidden');
            }
        });

        // Handle form submission
        const form = document.getElementById('payment-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitButton = document.getElementById('submit-button');
            const statusDiv = document.getElementById('payment-status');
            
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';
            statusDiv.innerHTML = '<div class="text-blue-600 font-semibold">Processing payment...</div>';

            try {
                // Get form data
                const billingData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zip: document.getElementById('zip').value,
                    shippingDate: document.querySelector('input[name="shippingDate"]:checked').value
                };
                
                const monthlySubscription = document.getElementById('monthlySubscription').checked;
                const total = letterPackages.reduce((sum, pkg) => {
                    const price = pkg.packageType === 'basic' ? 19.99 : pkg.packageType === 'deluxe' ? 29.99 : 59.99;
                    return sum + price;
                }, 0);

                // Create payment intent
                const response = await fetch('https://zdufkwflqbfppldctjdh.supabase.co/functions/v1/make-server-cf244566/create-payment-intent', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkdWZrd2ZscWJmcHBsZGN0amRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2ODQ0MzYsImV4cCI6MjA1MTI2MDQzNn0.F2JQvl7lJ6NLe8ym7AMQqLdOYeFxMhBGOZmqg4cPvuc'
                    },
                    body: JSON.stringify({
                        letterPackages: letterPackages,
                        billingData: billingData,
                        monthlySubscription: monthlySubscription,
                        total: total,
                        affiliateId: localStorage.getItem('affiliateId') || null,
                        subIds: JSON.parse(localStorage.getItem('subIds') || '{}')
                    })
                });

                const { clientSecret } = await response.json();

                // Confirm payment
                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: `${billingData.firstName} ${billingData.lastName}`,
                            email: billingData.email,
                            phone: billingData.phone,
                            address: {
                                line1: billingData.address,
                                city: billingData.city,
                                state: billingData.state,
                                postal_code: billingData.zip,
                                country: 'US'
                            }
                        }
                    }
                });

                if (error) {
                    throw new Error(error.message);
                }

                if (paymentIntent.status === 'succeeded') {
                    // Save order
                    const saveResponse = await fetch('https://zdufkwflqbfppldctjdh.supabase.co/functions/v1/make-server-cf244566/confirm-payment', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkdWZrd2ZscWJmcHBsZGN0amRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2ODQ0MzYsImV4cCI6MjA1MTI2MDQzNn0.F2JQvl7lJ6NLe8ym7AMQqLdOYeFxMhBGOZmqg4cPvuc'
                        },
                        body: JSON.stringify({
                            paymentIntentId: paymentIntent.id,
                            letterPackages: letterPackages,
                            billingData: billingData,
                            monthlySubscription: monthlySubscription,
                            total: total,
                            affiliateId: localStorage.getItem('affiliateId') || null,
                            subIds: JSON.parse(localStorage.getItem('subIds') || '{}')
                        })
                    });

                    const orderData = await saveResponse.json();

                    // Store order info for upsell page
                    localStorage.setItem('orderToken', orderData.accessToken);
                    localStorage.setItem('orderAmount', total.toString());
                    localStorage.setItem('subscriptionAccepted', monthlySubscription.toString());
                    
                    // Redirect to upsell
                    window.location.href = '/upsell.html';
                }

            } catch (error) {
                console.error('Payment error:', error);
                statusDiv.innerHTML = `<div class="text-red-600">Error: ${error.message}</div>`;
                submitButton.disabled = false;
                submitButton.textContent = 'Complete Order Securely üéÖ';
            }
        });
    </script>
</body>
</html>
