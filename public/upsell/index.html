<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Special Offer - Letters From Santa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
  <!-- Trackdesk tracker begin -->
<script async src="//cdn.trackdesk.com/tracking.js"></script>
<script>
  (function(t,d,k){(t[k]=t[k]||[]).push(d);t[d]=t[d]||t[k].f||function(){(t[d].q=t[d].q||[]).push(arguments)}})(window,"trackdesk","TrackdeskObject");

  // Calculate order value and get order ID from localStorage
  var orderToken = localStorage.getItem('orderAccessToken') || "";
  var cartItems = JSON.parse(localStorage.getItem('santaCart') || '[]');
  var orderValue = 0;
  
  if (cartItems.length > 0) {
    orderValue = cartItems.reduce(function(sum, item) { 
      return sum + (item.price * item.quantity); 
    }, 0);
  }

  trackdesk("directwebinteractive", "conversion", {
    "conversionType": "sale",
    "externalId": orderToken,
    "customParams": {
      "advS1": orderValue.toFixed(2)
    }
  });
</script>
<!-- Trackdesk tracker end -->
  
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .pacifico { font-family: 'Pacifico', cursive; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="min-h-screen">
    
    <!-- Subscription Upsell Page (shows FIRST) -->
    <div id="subscription-page" class="min-h-screen bg-gradient-to-br from-green-700 via-blue-700 to-green-800 flex items-center justify-center p-4">
        <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Timer Banner -->
            <div class="bg-green-600 text-white py-4 px-6 flex items-center justify-center gap-2">
                <svg class="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-lg font-bold">Limited Time Offer: <span id="sub-timer">2:00</span></span>
            </div>

            <!-- Main Content -->
            <div class="grid lg:grid-cols-2 gap-8 p-6 lg:p-8">
                <!-- Left Column - Offer Details -->
                <div class="flex flex-col justify-center">
                    <div class="mb-4">
                        <h1 class="text-3xl lg:text-4xl font-bold text-green-700 mb-3">
                            üéÅ Wait! Keep The Magic Alive All Year!
                        </h1>
                        <p class="text-gray-700 text-lg leading-relaxed mb-4">
                            Get a <strong>Free Personalized North Pole Dream Pass</strong> and a <strong>Personalized Autographed Picture of Santa</strong> when you try out Santa's Magical Journey!
                        </p>
                        <p class="text-gray-700 text-lg leading-relaxed mb-4">
                            Starting in January, Santa himself sends a personalized package sharing stories of his travels from around the world.
                        </p>
                        <p class="text-green-700 text-xl font-bold leading-relaxed">
                            Children everywhere are loving staying up to date with Santa and his crew! Your child will be thrilled to receive their very own letter from the North Pole each month! üéÖ‚ú®
                        </p>
                    </div>

                    <!-- Bonus Gifts Box -->
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-5 mb-4 text-white shadow-lg">
                        <p class="font-bold text-xl mb-3">‚ú® Your 2 FREE Bonus Gifts:</p>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">üé´</span>
                                <span class="font-semibold">Personalized North Pole Dream Pass</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">üì∏</span>
                                <span class="font-semibold">Personalized Autographed Picture of Santa</span>
                            </div>
                        </div>
                    </div>

                    <!-- Features List -->
                    <ul class="space-y-2">
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-gray-700">Personalized letter from Santa every month</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-gray-700">Keep the magic alive year-round</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-gray-700">Cancel anytime with no hassle</span>
                        </li>
                    </ul>
                </div>

                <!-- Right Column - Pricing & CTA -->
                <div class="flex flex-col justify-start">
                    <!-- Price Badge -->
                    <div class="bg-green-50 border-2 border-green-600 rounded-xl p-6 mb-4">
                        <div class="text-center">
                            <p class="text-gray-700 font-semibold mb-2">FREE Today and Starting in January</p>
                            <div class="flex items-center justify-center gap-2">
                                <span class="text-5xl font-bold text-green-700">$12</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity Auto-Selected Message -->
                    <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4 text-center">
                        <p class="text-blue-900 font-semibold">
                            ‚úÖ Auto-selected for <span id="sub-quantity-display">1</span> <span id="sub-children-text">child</span>
                        </p>
                        <p class="text-sm text-blue-700 mt-1">Based on your order</p>
                    </div>

                    <!-- Subscription Quantity Adjuster (for 5+ children) -->
                    <div id="sub-quantity-adjuster" class="hidden mb-4">
                        <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4">
                            <p class="text-sm text-gray-700 mb-3 text-center">
                                üí° <strong>Tip:</strong> You can adjust the number of subscriptions:
                            </p>
                            <div class="flex items-center justify-center gap-4">
                                <button onclick="decreaseSubscriptionQuantity()" class="px-6 py-2 text-lg font-bold border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">‚àí</button>
                                <div class="text-center">
                                    <div id="sub-qty-adjust-display" class="text-2xl font-bold text-green-700">5</div>
                                    <div class="text-xs text-gray-600">subscriptions</div>
                                </div>
                                <button onclick="increaseSubscriptionQuantity()" class="px-6 py-2 text-lg font-bold border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">+</button>
                            </div>
                            <p class="text-center text-sm text-gray-600 mt-2">
                                $<span id="sub-monthly-total">60</span>/month starting January
                            </p>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="sub-error-message" class="hidden mb-3 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700"></div>

                    <!-- Action Buttons -->
                    <div class="space-y-3">
                        <button 
                            id="sub-accept-btn" 
                            onclick="acceptSubscription()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-6 text-xl font-bold shadow-lg rounded-lg transition-colors"
                        >
                            <span id="sub-accept-text">‚úì Yes! Get 2 Extra FREE Gifts + Santa's Magical Journey</span>
                            <span id="sub-accept-loading" class="hidden">Processing...</span>
                        </button>

                        <button 
                            id="sub-decline-btn" 
                            onclick="declineSubscription()"
                            class="w-full text-gray-600 hover:text-gray-800 py-3 rounded-lg transition-colors"
                        >
                            No thanks, I don't wish to join Santa's Magical Journey
                        </button>
                    </div>

                    <p class="text-center text-sm text-gray-500 mt-3">
                        üîí Secure checkout ‚Ä¢ üí≥ Same payment method
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="upsell-page" class="min-h-screen bg-gradient-to-br from-red-700 via-green-700 to-red-800 flex items-center justify-center p-4 hidden">
        <div class="max-w-6xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Timer Banner -->
            <div class="bg-red-600 text-white py-4 px-6 flex items-center justify-center gap-2">
                <svg class="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-lg font-bold">Limited Time Offer: <span id="timer">2:00</span></span>
            </div>

            <!-- Main Content -->
            <div class="grid lg:grid-cols-2 gap-8 p-6 lg:p-8">
                <!-- Left Column - Product Image -->
                <div class="flex flex-col items-center justify-start bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 lg:p-8 pt-4">
                    <img 
                        src="https://images.unsplash.com/photo-1737671832208-fdfc86a90985?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxzbm93JTIwZ2xvYmUlMjB3aW50ZXIlMjBnaWZ0JTIwcHJvZHVjdHxlbnwxfHx8fDE3NjQwMjA2ODl8MA&ixlib=rb-4.1.0&q=80&w=1080"
                        alt="Certified North Pole Snow"
                        class="w-full max-w-sm h-auto object-contain drop-shadow-2xl rounded-lg"
                    />
                    <div class="mt-4 text-center">
                        <h3 class="text-xl font-bold text-blue-900 mb-2">üéÑ Authentic North Pole Snow</h3>
                        <p class="text-gray-600">Certified & Collectible</p>
                    </div>
                    
                    <!-- Features List -->
                    <ul class="space-y-2 mt-4 w-full max-w-md">
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-gray-700">Authentic certified snow from the North Pole</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-gray-700">Beautiful collectible jar with certificate</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-gray-700">Perfect keepsake to treasure forever</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-gray-700">Ships FREE with your Santa letter order</span>
                        </li>
                    </ul>
                </div>

                <!-- Right Column - Offer Details -->
                <div class="flex flex-col justify-start">
                    <div class="mb-4">
                        <h1 class="text-3xl lg:text-4xl font-bold text-red-700 mb-3">
                            üéÅ Wait! Add Certified North Pole Snow!
                        </h1>
                        <p class="text-gray-700 text-lg leading-relaxed">
                            Complete your magical experience with authentic snow from the North Pole! 
                            This special jar of certified snow makes the perfect keepsake.
                        </p>
                    </div>

                    <!-- Price Badge -->
                    <div class="bg-green-50 border-2 border-green-600 rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-gray-700 font-medium">Special One-Time Offer</span>
                            <span class="text-3xl font-bold text-green-700">$9.99</span>
                        </div>
                        <p class="text-sm text-gray-600">per jar</p>
                    </div>

                    <!-- Quantity Selector -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-3 text-center">
                            Select Quantity:
                        </label>
                        
                        <!-- Quick Select Buttons -->
                        <div class="flex flex-wrap gap-2 mb-4 justify-center">
                            <button onclick="setUpsellQuantity(1)" class="qty-btn-upsell px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">1</button>
                            <button onclick="setUpsellQuantity(2)" class="qty-btn-upsell px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">2</button>
                            <button onclick="setUpsellQuantity(3)" class="qty-btn-upsell px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">3</button>
                            <button onclick="setUpsellQuantity(4)" class="qty-btn-upsell px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">4</button>
                            <button onclick="setUpsellQuantity(5)" class="qty-btn-upsell px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">5</button>
                        </div>

                        <!-- Plus/Minus Controls -->
                        <div class="flex items-center gap-4 justify-center">
                            <button onclick="decreaseUpsellQuantity()" class="px-8 py-3 text-xl font-bold border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">‚àí</button>
                            <div class="flex-1 text-center max-w-[100px]">
                                <div id="upsell-quantity-display" class="text-3xl font-bold text-gray-900">1</div>
                                <div id="upsell-quantity-label" class="text-sm text-gray-600">jar</div>
                            </div>
                            <button onclick="increaseUpsellQuantity()" class="px-8 py-3 text-xl font-bold border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">+</button>
                        </div>

                        <!-- Total Price -->
                        <div class="mt-4 text-center py-3 bg-gray-50 rounded-lg">
                            <span class="text-gray-700">Total: </span>
                            <span id="upsell-total-price" class="text-2xl font-bold text-green-700">$9.99</span>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="error-message" class="hidden mb-3 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700"></div>

                    <!-- Action Buttons -->
                    <div class="space-y-3">
                        <button 
                            id="accept-btn" 
                            onclick="acceptUpsell()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-6 text-xl font-bold shadow-lg rounded-lg transition-colors"
                        >
                            <span id="accept-text">‚úì Yes! Add <span id="accept-qty">1</span> <span id="accept-label">Jar</span></span>
                            <span id="accept-loading" class="hidden">Adding to Order...</span>
                        </button>

                        <button 
                            id="decline-btn" 
                            onclick="declineUpsell()"
                            class="w-full text-gray-600 hover:text-gray-800 py-3 rounded-lg transition-colors"
                        >
                            No thanks, I don't want this special offer
                        </button>
                    </div>

                    <p class="text-center text-sm text-gray-500 mt-3">
                        üîí Secure checkout ‚Ä¢ üí≥ Same payment method
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Downsell Page (hidden initially) -->
    <div id="downsell-page" class="hidden min-h-screen bg-gradient-to-br from-orange-600 via-red-600 to-pink-700 flex items-center justify-center p-4">
        <div class="max-w-4xl w-full bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="bg-orange-600 text-white py-6 px-6 text-center">
                <h1 class="text-3xl font-bold mb-2">‚è∞ LAST CHANCE!</h1>
                <p class="text-lg">Before you go... here's an even better deal!</p>
            </div>

            <!-- Content -->
            <div class="p-8">
                <div class="text-center mb-6">
                    <h2 class="text-4xl font-bold text-orange-700 mb-4">
                        How About Just $7.99?
                    </h2>
                    <p class="text-xl text-gray-700 mb-4">
                        We really want you to have this magical keepsake!
                    </p>
                    <div class="inline-block bg-yellow-100 border-2 border-yellow-400 rounded-lg px-6 py-3 mb-4">
                        <span class="text-gray-500 line-through text-2xl">$9.99</span>
                        <span class="text-4xl font-bold text-orange-600 ml-3">$7.99</span>
                        <span class="text-sm text-gray-600 ml-2">per jar</span>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 mb-6">
                    <img 
                        src="https://images.unsplash.com/photo-1737671832208-fdfc86a90985?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxzbm93JTIwZ2xvYmUlMjB3aW50ZXIlMjBnaWZ0JTIwcHJvZHVjdHxlbnwxfHx8fDE3NjQwMjA2ODl8MA&ixlib=rb-4.1.0&q=80&w=1080"
                        alt="North Pole Snow"
                        class="w-full max-w-xs mx-auto h-auto object-contain drop-shadow-xl rounded-lg"
                    />
                </div>

                <!-- Quantity Selector for Downsell -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-3 text-center">
                        Select Quantity:
                    </label>
                    
                    <!-- Quick Select Buttons -->
                    <div class="flex flex-wrap gap-2 mb-4 justify-center">
                        <button onclick="setDownsellQuantity(1)" class="qty-btn-downsell px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">1</button>
                        <button onclick="setDownsellQuantity(2)" class="qty-btn-downsell px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">2</button>
                        <button onclick="setDownsellQuantity(3)" class="qty-btn-downsell px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">3</button>
                        <button onclick="setDownsellQuantity(4)" class="qty-btn-downsell px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">4</button>
                        <button onclick="setDownsellQuantity(5)" class="qty-btn-downsell px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">5</button>
                    </div>

                    <!-- Plus/Minus Controls -->
                    <div class="flex items-center gap-4 justify-center">
                        <button onclick="decreaseDownsellQuantity()" class="px-8 py-3 text-xl font-bold border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">‚àí</button>
                        <div class="flex-1 text-center max-w-[100px]">
                            <div id="downsell-quantity-display" class="text-3xl font-bold text-gray-900">1</div>
                            <div id="downsell-quantity-label" class="text-sm text-gray-600">jar</div>
                        </div>
                        <button onclick="increaseDownsellQuantity()" class="px-8 py-3 text-xl font-bold border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">+</button>
                    </div>

                    <!-- Total Price -->
                    <div class="mt-4 text-center py-3 bg-yellow-50 rounded-lg border-2 border-yellow-400">
                        <span class="text-gray-700">Total: </span>
                        <span id="downsell-total-price" class="text-2xl font-bold text-orange-600">$7.99</span>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="downsell-error" class="hidden mb-3 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700"></div>

                <!-- Buttons -->
                <div class="space-y-3">
                    <button 
                        id="downsell-accept-btn"
                        onclick="acceptDownsell()"
                        class="w-full bg-orange-600 hover:bg-orange-700 text-white py-6 text-2xl font-bold shadow-lg rounded-lg transition-colors"
                    >
                        <span id="downsell-accept-text">üéâ YES! Give Me <span id="downsell-qty">1</span> <span id="downsell-label">Jar</span> for $<span id="downsell-price">7.99</span>!</span>
                        <span id="downsell-loading" class="hidden">Processing...</span>
                    </button>

                    <button 
                        onclick="skipDownsell()"
                        class="w-full text-gray-600 hover:text-gray-800 py-3 rounded-lg transition-colors"
                    >
                        No thanks, continue to my order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Stripe
        const stripe = Stripe('pk_live_51SIHQT2NsH2CKfRANHrn5PsrTTnvRY0t5QStLGW8W3ihy4dhFVhDX4ZIP3lrOYhA1HPtnflUgDAhDxEZ0TgNB1V000lsmZhQBB');
        
        // Get order token from localStorage (saved by checkout page)
        const orderToken = localStorage.getItem('orderAccessToken');
        console.log('üîë Order token:', orderToken);
        
        // Quantity management
        let upsellQuantity = 1;
        let downsellQuantity = 1;
        let subscriptionQuantity = 1; // Subscription quantity based on letter count
        const UPSELL_PRICE = 9.99;
        const DOWNSELL_PRICE = 7.99;
        let processing = false;

        // Timer Management
        let timeLeft = 120; // 2 minutes
        let currentTimer = null;

        // Start subscription page timer
        function startSubscriptionTimer() {
            const timerDisplay = document.getElementById('sub-timer');
            if (!timerDisplay) return;
            
            timeLeft = 120;
            if (currentTimer) clearInterval(currentTimer);
            
            currentTimer = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(currentTimer);
                    // Show next offer instead of going to success page
                    console.log('‚è±Ô∏è Timer expired, showing next offer');
                    document.getElementById('subscription-page').classList.add('hidden');
                    document.getElementById('upsell-page').classList.remove('hidden');
                    initializeSnowQuantity(); // Auto-select quantity
                    startUpsellTimer();
                }
            }, 1000);
        }

        // Start upsell page timer
        function startUpsellTimer() {
            const timerDisplay = document.getElementById('timer');
            if (!timerDisplay) return;
            
            if (currentTimer) clearInterval(currentTimer);
            
            currentTimer = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(currentTimer);
                    // Show downsell instead of going to success page
                    console.log('‚è±Ô∏è Snow timer expired, showing downsell');
                    document.getElementById('upsell-page').classList.add('hidden');
                    document.getElementById('downsell-page').classList.remove('hidden');
                }
            }, 1000);
        }

        // Upsell quantity functions
        function updateUpsellTotal() {
            const total = (upsellQuantity * UPSELL_PRICE).toFixed(2);
            document.getElementById('upsell-total-price').textContent = '$' + total;
            document.getElementById('accept-qty').textContent = upsellQuantity;
            document.getElementById('accept-label').textContent = upsellQuantity === 1 ? 'Jar' : 'Jars';
            // Removed price from button text
            document.getElementById('upsell-quantity-display').textContent = upsellQuantity;
            document.getElementById('upsell-quantity-label').textContent = upsellQuantity === 1 ? 'jar' : 'jars';
            
            // Update active button style
            document.querySelectorAll('.qty-btn-upsell').forEach((btn, index) => {
                if (index + 1 === upsellQuantity) {
                    btn.className = 'qty-btn-upsell px-6 py-3 rounded-lg font-semibold transition-all bg-green-600 text-white shadow-lg scale-105';
                } else {
                    btn.className = 'qty-btn-upsell px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200';
                }
            });
        }

        function setUpsellQuantity(num) {
            if (!processing) {
                upsellQuantity = num;
                updateUpsellTotal();
            }
        }

        function increaseUpsellQuantity() {
            if (!processing) {
                upsellQuantity++;
                updateUpsellTotal();
            }
        }

        function decreaseUpsellQuantity() {
            if (!processing && upsellQuantity > 1) {
                upsellQuantity--;
                updateUpsellTotal();
            }
        }

        // Downsell quantity functions
        function updateDownsellTotal() {
            const total = (downsellQuantity * DOWNSELL_PRICE).toFixed(2);
            document.getElementById('downsell-total-price').textContent = '$' + total;
            document.getElementById('downsell-qty').textContent = downsellQuantity;
            document.getElementById('downsell-label').textContent = downsellQuantity === 1 ? 'Jar' : 'Jars';
            document.getElementById('downsell-price').textContent = total;
            document.getElementById('downsell-quantity-display').textContent = downsellQuantity;
            document.getElementById('downsell-quantity-label').textContent = downsellQuantity === 1 ? 'jar' : 'jars';
            
            // Update active button style
            document.querySelectorAll('.qty-btn-downsell').forEach((btn, index) => {
                if (index + 1 === downsellQuantity) {
                    btn.className = 'qty-btn-downsell px-6 py-3 rounded-lg font-semibold transition-all bg-orange-600 text-white shadow-lg scale-105';
                } else {
                    btn.className = 'qty-btn-downsell px-6 py-3 rounded-lg font-semibold transition-all bg-gray-100 text-gray-700 hover:bg-gray-200';
                }
            });
        }

        function setDownsellQuantity(num) {
            if (!processing) {
                downsellQuantity = num;
                updateDownsellTotal();
            }
        }

        function increaseDownsellQuantity() {
            if (!processing) {
                downsellQuantity++;
                updateDownsellTotal();
            }
        }

        function decreaseDownsellQuantity() {
            if (!processing && downsellQuantity > 1) {
                downsellQuantity--;
                updateDownsellTotal();
            }
        }

        // Accept upsell
        async function acceptUpsell() {
            if (processing) return;
            
            const button = document.getElementById('accept-btn');
            const errorDiv = document.getElementById('error-message');
            
            processing = true;
            button.disabled = true;
            document.getElementById('accept-text').classList.add('hidden');
            document.getElementById('accept-loading').classList.remove('hidden');
            errorDiv.classList.add('hidden');
            
            try {
                const total = upsellQuantity * UPSELL_PRICE;
                
                console.log('üîÑ Accepting upsell:', { orderToken, quantity: upsellQuantity, amount: total });
                
                // Process upsell payment via backend
                const response = await fetch('https://bgpcgrhfnmvaxbkfzcxo.supabase.co/functions/v1/make-server-cf244566/upsell/accept-snow', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJncGNncmhmbm12YXhia2Z6Y3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjY3MzAsImV4cCI6MjA3NjA0MjczMH0.eDun3lViK4XA--bTwRTqyCTBO40B8JU7m12mc4Jz2mo'
                    },
                    body: JSON.stringify({
                        orderToken: orderToken,
                        quantity: upsellQuantity
                    })
                });

                const result = await response.json();
                console.log('üìä Upsell response:', result);
                
                if (result.success) {
                    clearInterval(currentTimer);
                    
                    // Fire Trackdesk upsell conversion
                    if (window.trackdesk) {
                        trackdesk("directwebinteractive", "conversion", {
                            "conversionType": "sale",
                            "event_id": 'upsell_' + Date.now() + '_' + Math.random(),
                            "value": total
                        });
                        console.log('üî• Trackdesk UPSELL pixel fired');
                    }
                    
                    // Show success and redirect
                    button.innerHTML = '‚úÖ Snow Added!';
                    setTimeout(() => {
                        window.location.href = '/?token=' + orderToken;
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Payment failed');
                }
            } catch (err) {
                console.error('‚ùå Upsell error:', err);
                errorDiv.textContent = err.message || 'Error processing upsell. Please try again.';
                errorDiv.classList.remove('hidden');
                processing = false;
                button.disabled = false;
                document.getElementById('accept-text').classList.remove('hidden');
                document.getElementById('accept-loading').classList.add('hidden');
            }
        }

        // Decline upsell - show downsell
        function declineUpsell() {
            if (processing) return;
            console.log('‚¨áÔ∏è Showing downsell page');
            clearInterval(currentTimer);
            document.getElementById('upsell-page').classList.add('hidden');
            document.getElementById('downsell-page').classList.remove('hidden');
        }

        // Accept downsell
        async function acceptDownsell() {
            if (processing) return;
            
            const button = document.getElementById('downsell-accept-btn');
            const errorDiv = document.getElementById('downsell-error');
            
            processing = true;
            button.disabled = true;
            document.getElementById('downsell-accept-text').classList.add('hidden');
            document.getElementById('downsell-loading').classList.remove('hidden');
            errorDiv.classList.add('hidden');
            
            try {
                const total = downsellQuantity * DOWNSELL_PRICE;
                console.log('üîÑ Accepting downsell:', { orderToken, quantity: downsellQuantity, price: total });
                
                // FIXED: Use correct endpoint accept-snow-downsell
                const response = await fetch('https://bgpcgrhfnmvaxbkfzcxo.supabase.co/functions/v1/make-server-cf244566/upsell/accept-snow-downsell', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJncGNncmhmbm12YXhia2Z6Y3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjY3MzAsImV4cCI6MjA3NjA0MjczMH0.eDun3lViK4XA--bTwRTqyCTBO40B8JU7m12mc4Jz2mo'
                    },
                    body: JSON.stringify({
                        orderToken: orderToken,
                        quantity: downsellQuantity
                    })
                });

                const result = await response.json();
                console.log('üìä Downsell response:', result);
                
                if (result.success) {
                    // Fire Trackdesk downsell conversion
                    if (window.trackdesk) {
                        trackdesk("directwebinteractive", "conversion", {
                            "conversionType": "sale",
                            "event_id": 'downsell_' + Date.now() + '_' + Math.random(),
                            "value": total
                        });
                        console.log('üî• Trackdesk DOWNSELL pixel fired');
                    }
                    
                    // Show success and redirect
                    button.innerHTML = '‚úÖ Snow Added!';
                    setTimeout(() => {
                        window.location.href = '/?token=' + orderToken;
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Payment failed');
                }
            } catch (err) {
                console.error('‚ùå Downsell error:', err);
                errorDiv.textContent = err.message || 'Error processing downsell. Please try again.';
                errorDiv.classList.remove('hidden');
                processing = false;
                button.disabled = false;
                document.getElementById('downsell-accept-text').classList.remove('hidden');
                document.getElementById('downsell-loading').classList.add('hidden');
            }
        }

        // Skip downsell - go to success
        function skipDownsell() {
            console.log('‚è≠Ô∏è Skipping downsell');
            window.location.href = '/?token=' + orderToken;
        }

        // Check if order token exists
        if (!orderToken) {
            console.error('‚ùå No order token found!');
            window.location.href = '/';
        }

        // Subscription functions
        async function acceptSubscription() {
            if (processing) return;
            
            const button = document.getElementById('sub-accept-btn');
            const errorDiv = document.getElementById('sub-error-message');
            
            processing = true;
            button.disabled = true;
            document.getElementById('sub-accept-text').classList.add('hidden');
            document.getElementById('sub-accept-loading').classList.remove('hidden');
            errorDiv.classList.add('hidden');
            
            try {
                const total = subscriptionQuantity * 12; // $12 per child per month
                console.log('üîÑ Accepting subscription:', { orderToken, quantity: subscriptionQuantity, monthlyPrice: total });
                
                const response = await fetch('https://bgpcgrhfnmvaxbkfzcxo.supabase.co/functions/v1/make-server-cf244566/upsell/accept-subscription', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJncGNncmhmbm12YXhia2Z6Y3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjY3MzAsImV4cCI6MjA3NjA0MjczMH0.eDun3lViK4XA--bTwRTqyCTBO40B8JU7m12mc4Jz2mo'
                    },
                    body: JSON.stringify({
                        orderToken: orderToken,
                        quantity: subscriptionQuantity
                    })
                });

                const result = await response.json();
                console.log('üìä Subscription response:', result);
                
                if (result.success) {
                    // Fire Trackdesk subscription conversion
                    if (window.trackdesk) {
                        trackdesk("directwebinteractive", "conversion", {
                            "conversionType": "sale",
                            "event_id": 'subscription_' + Date.now() + '_' + Math.random(),
                            "value": total
                        });
                        console.log('üî• Trackdesk SUBSCRIPTION pixel fired');
                    }
                    
                    // Show success and redirect to NEXT OFFER (snow upsell)
                    button.innerHTML = '‚úÖ Subscription Added!';
                    setTimeout(() => {
                        // Show next offer instead of going to success page
                        clearInterval(currentTimer);
                        document.getElementById('subscription-page').classList.add('hidden');
                        document.getElementById('upsell-page').classList.remove('hidden');
                        initializeSnowQuantity(); // Auto-select quantity
                        startUpsellTimer();
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Payment failed');
                }
            } catch (err) {
                console.error('‚ùå Subscription error:', err);
                errorDiv.textContent = err.message || 'Error processing subscription. Please try again.';
                errorDiv.classList.remove('hidden');
                processing = false;
                button.disabled = false;
                document.getElementById('sub-accept-text').classList.remove('hidden');
                document.getElementById('sub-accept-loading').classList.add('hidden');
            }
        }

        // Decline subscription - show upsell
        function declineSubscription() {
            if (processing) return;
            console.log('‚¨áÔ∏è Showing upsell page');
            clearInterval(currentTimer);
            document.getElementById('subscription-page').classList.add('hidden');
            document.getElementById('upsell-page').classList.remove('hidden');
            initializeSnowQuantity(); // Auto-select quantity
            startUpsellTimer();
        }

        // Initialize subscription quantity based on number of letters
        function initializeSubscriptionQuantity() {
            try {
                const packages = JSON.parse(localStorage.getItem('santaLetterPackages') || '[]');
                const letterCount = packages.length || 1;
                
                console.log('üì¶ Found', letterCount, 'letters in order');
                
                // Update subscription display
                document.getElementById('sub-quantity-display').textContent = letterCount;
                document.getElementById('sub-children-text').textContent = letterCount === 1 ? 'child' : 'children';
                
                // Set the subscription quantity (used when accepting)
                subscriptionQuantity = letterCount;
                
                // Show quantity adjuster if 5+ children
                if (letterCount >= 5) {
                    document.getElementById('sub-quantity-adjuster').classList.remove('hidden');
                    document.getElementById('sub-qty-adjust-display').textContent = letterCount;
                    document.getElementById('sub-monthly-total').textContent = (letterCount * 12).toFixed(2);
                }
            } catch (error) {
                console.error('Error loading letter count:', error);
            }
        }

        // Adjust subscription quantity
        function updateSubscriptionTotal() {
            const total = (subscriptionQuantity * 12).toFixed(2);
            document.getElementById('sub-monthly-total').textContent = total;
            document.getElementById('sub-qty-adjust-display').textContent = subscriptionQuantity;
        }

        function setSubscriptionQuantity(num) {
            if (!processing) {
                subscriptionQuantity = num;
                updateSubscriptionTotal();
            }
        }

        function increaseSubscriptionQuantity() {
            if (!processing) {
                subscriptionQuantity++;
                updateSubscriptionTotal();
            }
        }

        function decreaseSubscriptionQuantity() {
            if (!processing && subscriptionQuantity > 1) {
                subscriptionQuantity--;
                updateSubscriptionTotal();
            }
        }

        // Initialize on page load
        initializeSubscriptionQuantity();
        startSubscriptionTimer();
        
        // Initialize snow upsell quantity when the page switches to it
        function initializeSnowQuantity() {
            try {
                const packages = JSON.parse(localStorage.getItem('santaLetterPackages') || '[]');
                const letterCount = packages.length || 1;
                
                console.log('‚ùÑÔ∏è Auto-selecting', letterCount, 'jars based on order');
                
                // Set the upsell quantity to match letter count
                upsellQuantity = letterCount;
                updateUpsellTotal();
            } catch (error) {
                console.error('Error auto-selecting snow quantity:', error);
            }
        }
    </script>

</body>
</html>